{% extends "admin/base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head %}
<!-- Toast UI Editor CSS -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" />
<style>
    #editor {
        margin-bottom: 1rem;
    }
    .toastui-editor-defaultUI {
        border: 1px solid var(--border-color);
        border-radius: 6px;
    }
    /* Compact form layout */
    .post-form-container .form-group {
        margin-bottom: 1rem;
    }
    .post-form-container small {
        margin-top: 0.25rem;
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>{{ title }}</h1>
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
</div>

<div class="card post-form-container" style="max-width: 1100px;">
    <form method="POST" novalidate>
        {{ form.hidden_tag() }}

        <div class="form-group">
            {{ form.title.label }}
            {{ form.title(class="form-control") }}
            {% if form.title.errors %}
                <span style="color: #dc3545; font-size: 0.85rem;">{{ form.title.errors[0] }}</span>
            {% endif %}
        </div>

        <div class="form-group">
            {{ form.slug.label }}
            {{ form.slug(class="form-control") }}
            {% if form.slug.errors %}
                <span style="color: #dc3545; font-size: 0.85rem;">{{ form.slug.errors[0] }}</span>
            {% endif %}
            <small style="color: var(--text-secondary); font-size: 0.85rem;">
                URL-friendly version of the title (e.g., my-blog-post)
            </small>
        </div>

        <div class="form-group">
            {{ form.excerpt.label }}
            {{ form.excerpt(class="form-control") }}
            {% if form.excerpt.errors %}
                <span style="color: #dc3545; font-size: 0.85rem;">{{ form.excerpt.errors[0] }}</span>
            {% endif %}
            <small style="color: var(--text-secondary); font-size: 0.85rem;">
                Brief summary shown in post listings
            </small>
        </div>

        <div class="form-group">
            {{ form.content.label }}
            <!-- Toast UI Editor Container -->
            <div id="editor"></div>
            <!-- Hidden field to store markdown content -->
            {{ form.content(style="display: none;") }}
            {% if form.content.errors %}
                <span style="color: #dc3545; font-size: 0.85rem;">{{ form.content.errors[0] }}</span>
            {% endif %}
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                {{ form.author.label }}
                {{ form.author(class="form-control") }}
                {% if form.author.errors %}
                    <span style="color: #dc3545; font-size: 0.85rem;">{{ form.author.errors[0] }}</span>
                {% endif %}
            </div>

            <div class="form-group">
                {{ form.category.label }}
                {{ form.category(class="form-control") }}
                {% if form.category.errors %}
                    <span style="color: #dc3545; font-size: 0.85rem;">{{ form.category.errors[0] }}</span>
                {% endif %}
            </div>
        </div>

        <div class="form-group">
            {{ form.tags.label }}
            {{ form.tags(class="form-control") }}
            {% if form.tags.errors %}
                <span style="color: #dc3545; font-size: 0.85rem;">{{ form.tags.errors[0] }}</span>
            {% endif %}
        </div>

        <div style="display: flex; gap: 2rem; margin-bottom: 1.5rem;">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="checkbox-label">
                    {{ form.published() }}
                    {{ form.published.label.text }}
                </label>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label class="checkbox-label">
                    {{ form.featured() }}
                    {{ form.featured.label.text }}
                </label>
            </div>
        </div>

        <div style="display: flex; gap: 1rem;">
            <button type="submit" class="btn">
                {% if post %}Update Post{% else %}Create Post{% endif %}
            </button>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<!-- Toast UI Editor JS -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

<script>
// Initialize Toast UI Editor
const { Editor } = toastui;

const editor = new Editor({
    el: document.querySelector('#editor'),
    height: '600px',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    initialValue: document.querySelector('#content').value || '',
    hooks: {
        addImageBlobHook: async (blob, callback) => {
            // Handle image upload
            const formData = new FormData();
            formData.append('image', blob);

            try {
                const response = await fetch('{{ url_for("upload_image") }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrf_token]').value
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    callback(data.url, 'Image');
                } else {
                    alert('Image upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Image upload failed');
            }
        }
    },
    toolbarItems: [
        ['heading', 'bold', 'italic', 'strike'],
        ['hr', 'quote'],
        ['ul', 'ol', 'task', 'indent', 'outdent'],
        ['table', 'image', 'link'],
        ['code', 'codeblock'],
        ['scrollSync'],
    ]
});

// Sync editor content to hidden field on form submit
document.querySelector('form').addEventListener('submit', function() {
    document.querySelector('#content').value = editor.getMarkdown();
});

// Auto-generate slug from title
document.querySelector('#title').addEventListener('input', function(e) {
    const slug = e.target.value
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    document.querySelector('#slug').value = slug;
});
</script>
{% endblock %}
